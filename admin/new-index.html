<!DOCTYPE html>
<!-- NEW ADMIN PANEL - 2025-01-14 -->
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NEW Admin ‚Äî Flamingo Auto</title>
    <link rel="stylesheet" href="../style.css">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        .admin-panel { max-width:900px; margin:2rem auto; padding:2rem; background:#fff; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .admin-panel h1 { margin-bottom:1rem; color: #1976d2; }
        .admin-panel label { display:block; margin-top:1rem; font-weight:600; color: #333; }
        .admin-panel input, .admin-panel textarea, .admin-panel select { 
            width:100%; padding:0.75rem; border:2px solid #e1e5e9; border-radius:8px; 
            font-size: 1rem; transition: border-color 0.3s;
        }
        .admin-panel input:focus, .admin-panel textarea:focus, .admin-panel select:focus {
            outline: none; border-color: #007bff;
        }
        .admin-actions { margin-top:1.5rem; display:flex; gap:1rem; flex-wrap:wrap; }
        .btn { 
            background: #007bff; color: white; padding: 0.75rem 1.5rem; 
            border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
            transition: background 0.3s;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .muted { color:#666; font-size:0.95rem; }
        .message { padding: 1rem; border-radius: 8px; margin: 1rem 0; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <main class="container admin-panel">
        <div class="hero-header">
            <a class="logo" href="../index.html">FLAMINGO AUTO</a>
            <div class="lang-switch">
                <a class="lang-btn" href="../index.html">ET</a>
                <a class="lang-btn" href="../ru.html">RU</a>
            </div>
        </div>
        
        <h1>üéØ –ù–æ–≤–∞—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
        <p class="muted">–ü—Ä–æ—Å—Ç–∞—è –∏ —Ä–∞–±–æ—á–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–≥–æ–º</p>

        <div id="login-area">
            <div style="background: #e3f2fd; padding: 2rem; border-radius: 8px; text-align: center;">
                <h3 style="color: #1976d2; margin-bottom: 1rem;">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                <p class="muted">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Netlify Identity –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∫–µ</p>
                <button id="login-btn" class="btn btn-success">üîë –í–æ–π—Ç–∏</button>
            </div>
        </div>

        <div id="editor-area" style="display:none;">
            <div style="background: #d4edda; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
                <span>‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: <strong id="user-email"></strong></span>
                <button id="logout-btn" class="btn btn-danger">üö™ –í—ã–π—Ç–∏</button>
            </div>

            <div style="background: #f8f9fa; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                <h3>‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ç—å—é</h3>
                
                <label for="post-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏ *</label>
                <input id="post-title" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏" required />

                <label for="post-content">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ *</label>
                <textarea id="post-content" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏..." required></textarea>

                <label for="post-author">–ê–≤—Ç–æ—Ä</label>
                <input id="post-author" type="text" value="Flamingo Auto" placeholder="–ê–≤—Ç–æ—Ä —Å—Ç–∞—Ç—å–∏" />

                <label for="post-locale">–Ø–∑—ã–∫ —Å—Ç–∞—Ç—å–∏</label>
                <select id="post-locale">
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    <option value="et">–≠—Å—Ç–æ–Ω—Å–∫–∏–π</option>
                    <option value="en">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
                </select>

                <div class="admin-actions">
                    <button id="save-post" class="btn btn-success">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—å—é</button>
                    <a href="../blog.html" class="btn">üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–ª–æ–≥</a>
                </div>

                <div id="admin-feedback" class="muted" style="margin-top:1rem;"></div>
            </div>
        </div>
    </main>

    <script>
        console.log('üöÄ NEW ADMIN PANEL LOADED - v2.0');
        
        let currentUser = null;

        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const loginArea = document.getElementById('login-area');
        const editorArea = document.getElementById('editor-area');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const saveBtn = document.getElementById('save-post');
        const userEmail = document.getElementById('user-email');
        const feedback = document.getElementById('admin-feedback');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Netlify Identity
        if (window.netlifyIdentity) {
            console.log('‚úÖ Netlify Identity –∑–∞–≥—Ä—É–∂–µ–Ω');
            
            window.netlifyIdentity.on("init", user => {
                console.log('Identity –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user ? user.email : '–Ω–µ—Ç');
                updateUI(user);
            });

            window.netlifyIdentity.on("login", user => {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª:', user.email);
                updateUI(user);
                showFeedback('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
            });

            window.netlifyIdentity.on("logout", () => {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª');
                updateUI(null);
            });

            window.netlifyIdentity.init();
        } else {
            console.error('‚ùå Netlify Identity –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI(user) {
            currentUser = user;
            if (user) {
                loginArea.style.display = 'none';
                editorArea.style.display = 'block';
                userEmail.textContent = user.email;
            } else {
                loginArea.style.display = 'block';
                editorArea.style.display = 'none';
            }
        }

        // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
        function showFeedback(message, isError = false) {
            feedback.innerHTML = `<div class="message ${isError ? 'error' : 'success'}">${message}</div>`;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏
        async function createPost(title, content, author, lang) {
            if (!currentUser) throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');

            const token = await currentUser.jwt();
            const date = new Date().toISOString();
            const slug = title.toLowerCase()
                .replace(/[^a-z–∞-—è0-9\s]/gi, '')
                .replace(/\s+/g, '-')
                .substring(0, 50);
            
            const filename = `${date.substring(0, 10)}-${slug}.md`;
            
            const frontmatter = `---
title: "${title}"
date: ${date}
author: "${author}"
lang: "${lang}"
published: true
---

${content}`;

            const response = await fetch(`https://api.github.com/repos/Vladislav9111/flamingoauto-site/contents/content/blog/${filename}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `Create blog post: ${title}`,
                    content: btoa(unescape(encodeURIComponent(frontmatter))),
                    branch: 'main'
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞');
            }

            return await response.json();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        loginBtn.addEventListener('click', () => {
            console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
            window.netlifyIdentity.open();
        });

        logoutBtn.addEventListener('click', () => {
            console.log('–í—ã—Ö–æ–¥–∏–º –∏–∑ —Å–∏—Å—Ç–µ–º—ã...');
            window.netlifyIdentity.logout();
        });

        saveBtn.addEventListener('click', async () => {
            const title = document.getElementById('post-title').value.trim();
            const content = document.getElementById('post-content').value.trim();
            const author = document.getElementById('post-author').value.trim() || 'Flamingo Auto';
            const lang = document.getElementById('post-locale').value;

            if (!title || !content) {
                showFeedback('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ.', true);
                return;
            }

            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'üîÑ –ü—É–±–ª–∏–∫—É–µ–º...';
            saveBtn.disabled = true;

            try {
                await createPost(title, content, author, lang);
                showFeedback('‚úÖ –°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ –≤ GitHub! –ü–æ—è–≤–∏—Ç—Å—è –≤ –±–ª–æ–≥–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.');
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
                document.getElementById('post-author').value = 'Flamingo Auto';
                document.getElementById('post-locale').value = 'ru';

            } catch (error) {
                showFeedback('‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + error.message, true);
                console.error('–û—à–∏–±–∫–∞:', error);
            } finally {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        });
    </script>

<script src="/js/upload-guard.js"></script>
</body>
</html>