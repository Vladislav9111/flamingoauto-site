const { Octokit } = require('@octokit/rest');

exports.handler = async (event, context) => {\n  if (event.httpMethod !== 'POST') {\n    return {\n      statusCode: 405,\n      body: JSON.stringify({ error: 'Method not allowed' }),\n    };\n  }\n\n  try {\n    // Получаем токен из заголовков\n    const authHeader = event.headers.authorization;\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return {\n        statusCode: 401,\n        body: JSON.stringify({ error: 'No authorization token' }),\n      };\n    }\n\n    const token = authHeader.replace('Bearer ', '');\n    \n    // Парсим multipart form data (упрощенная версия)\n    const boundary = event.headers['content-type'].split('boundary=')[1];\n    const body = event.body;\n    \n    // Извлекаем файл из form data (это упрощенная реализация)\n    // В продакшене лучше использовать библиотеку для парсинга multipart\n    const fileMatch = body.match(/Content-Disposition: form-data; name=\"file\"; filename=\"(.+?)\"/);  \n    const filename = fileMatch ? fileMatch[1] : 'image.jpg';\n    \n    // Извлекаем данные файла (base64)\n    const fileDataMatch = body.match(/Content-Type: image\\/.*?\\r\\n\\r\\n(.+?)\\r\\n/s);\n    if (!fileDataMatch) {\n      return {\n        statusCode: 400,\n        body: JSON.stringify({ error: 'No file data found' }),\n      };\n    }\n\n    const fileData = fileDataMatch[1];\n    \n    // Создаем уникальное имя файла\n    const timestamp = Date.now();\n    const ext = filename.split('.').pop();\n    const uniqueFilename = `${timestamp}-${Math.random().toString(36).substr(2, 9)}.${ext}`;\n    const imagePath = `static/images/blog/${uniqueFilename}`;\n    \n    // Загружаем в GitHub через API\n    const octokit = new Octokit({ auth: token });\n    \n    const response = await octokit.repos.createOrUpdateFileContents({\n      owner: 'Vladislav9111',\n      repo: 'flamingoauto-site',\n      path: imagePath,\n      message: `Add blog image: ${uniqueFilename}`,\n      content: Buffer.from(fileData, 'binary').toString('base64'),\n      author: {\n        name: 'Blog Admin',\n        email: 'admin@flamingoauto.eu'\n      }\n    });\n\n    return {\n      statusCode: 200,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({ \n        url: `/${imagePath}`,\n        filename: uniqueFilename \n      }),\n    };\n    \n  } catch (error) {\n    console.error('Error uploading image:', error);\n    return {\n      statusCode: 500,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({ error: 'Failed to upload image' }),\n    };\n  }\n};