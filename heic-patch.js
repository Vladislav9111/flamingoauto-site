// HEIC/HEIF → JPEG + validation patch
(function(){var ALLOWED_TYPES=['image/jpeg','image/png','image/heic','image/heif'];var MAX_FILES=15;var JPEG_QUALITY=0.86;function isHeicLike(f){var n=(f.name||'').toLowerCase(),t=(f.type||'').toLowerCase();return t.indexOf('heic')>=0||t.indexOf('heif')>=0||/\.hei[cf]$/i.test(n)}async function heicToJpegFile(f){if(!isHeicLike(f))return f;if(typeof window.heic2any!=='function')return f;try{var b=await window.heic2any({blob:f,toType:'image/jpeg',quality:JPEG_QUALITY});var n=(f.name||'photo').replace(/\.(heic|heif)$/i,'')+'.jpg';return new File([b],n,{type:'image/jpeg'})}catch(e){console.warn('HEIC→JPEG failed',e);return f}}async function maybeReencodeToJpeg(f){var t=(f.type||'').toLowerCase();if(t==='image/jpeg')return f;if(t==='image/png'||t==='image/heic'||t==='image/heif'){var buf=await f.arrayBuffer();var bmp=await createImageBitmap(new Blob([buf],{type:t||'application/octet-stream'}));var c=document.createElement('canvas');c.width=bmp.width;c.height=bmp.height;var x=c.getContext('2d');x.drawImage(bmp,0,0);var jb=await new Promise(function(res,rej){c.toBlob(function(b){b?res(b):rej(new Error('toBlob failed'))},'image/jpeg',JPEG_QUALITY)});var n=(f.name||'photo').replace(/\.(png|heic|heif)$/i,'')+'.jpg';return new File([jb],n,{type:'image/jpeg'})}return f}function filterSupported(fs){return fs.filter(function(f){var nameOk=/\.(jpe?g|png|heic|heif)$/i.test(f.name||'');var typeOk=ALLOWED_TYPES.indexOf((f.type||'').toLowerCase())>=0;return nameOk||typeOk})}function showUserError(m){alert(m||'Ошибка при подготовке файлов. Разрешены JPG/PNG/HEIC/HEIF.')}async function normalizeFilesForForm(i){var fs=Array.from((i&&i.files)||[]);if(!fs.length)return[];fs=filterSupported(fs);if(!fs.length){showUserError('Этот тип файла не поддерживается. Разрешены JPG/PNG/HEIC/HEIF.');return[]}if(fs.length>MAX_FILES)fs.length=MAX_FILES;for(var a=0;a<fs.length;a++)fs[a]=await heicToJpegFile(fs[a]);for(var b=0;b<fs.length;b++)fs[b]=await maybeReencodeToJpeg(fs[b]);var fin=fs.filter(function(f){return/\.(jpe?g|png)$/i.test(f.name||'')||/image\/jpeg|image\/png/i.test(f.type||'')});if(!fin.length){showUserError('Не удалось подготовить файлы к отправке. Попробуйте другое изображение.')}return fin}document.addEventListener('DOMContentLoaded',function(){try{var form=document.querySelector('form');var input=document.querySelector('input[type="file"]');if(!form||!input)return;form.addEventListener('submit',async function(e){if(!input.files||!input.files.length)return;e.preventDefault();try{var files=await normalizeFilesForForm(input);if(!files.length)return;var fd=new FormData(form);['photos','photos[]','images','images[]','file','files[]'].forEach(function(k){fd.delete(k)});files.forEach(function(f){fd.append('photos[]',f,f.name)});var a=form.getAttribute('action')||form.action||window.location.href;var m=(form.getAttribute('method')||form.method||'POST').toUpperCase();var resp=await fetch(a,{method:m,body:fd});if(!resp.ok){throw new Error('Upload failed: '+resp.status)}form.reset();alert('Заявка отправлена!')}catch(err){console.error(err);showUserError()}})}catch(ex){console.warn('heic-patch init failed',ex)}})})();