<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin ‚Äî Flamingo Auto</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">

    
    <style>
        /* Admin panel styling based on archive version */
        .admin-panel { 
            max-width: 900px; 
            margin: 2rem auto; 
            padding: 1.25rem; 
            background: #fff; 
            border-radius: 8px; 
        }
        .admin-panel h1 { margin-bottom: 0.5rem; }
        .admin-panel label { display: block; margin-top: 0.75rem; font-weight: 600; }
        .admin-panel input[type="text"], .admin-panel input[type="password"], .admin-panel textarea, .admin-panel select { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
        }
        .admin-actions { 
            margin-top: 1rem; 
            display: flex; 
            gap: 0.75rem; 
            flex-wrap: wrap; 
        }
        .muted { color: #666; font-size: 0.95rem; }
        .error-message { color: #dc3545; margin-top: 0.5rem; }
        .success-message { color: #28a745; margin-top: 0.5rem; }
        
        /* Login section */
        .login-section {
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .login-btn {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .login-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        /* Posts management */
        .post-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .post-item h3 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }
        .post-meta {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.75rem;
        }
        .post-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .post-actions .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <main class="container admin-panel">
        <div class="hero-header">
            <a class="logo" href="index.html">FLAMINGO AUTO</a>
            <div class="lang-switch" role="tablist" aria-label="Language switch">
                <a class="lang-btn" href="index.html" aria-pressed="true" role="tab">ET</a>
                <a class="lang-btn" href="ru.html" aria-pressed="false" role="tab">RU</a>
            </div>
        </div>
        
        <h1>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
        <p class="muted">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –±–ª–æ–≥.</p>

        <!-- –°–µ–∫—Ü–∏—è –≤—Ö–æ–¥–∞ -->
        <div id="login-area">
            <label for="admin-password">–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
            <input id="admin-password" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
            <div class="admin-actions">
                <button id="login-btn" class="btn">üîë –í–æ–π—Ç–∏</button>
                <a href="blog.html" class="btn" style="background:#fff;color:var(--primary-color);border:1px solid #eee;">üìñ –ë–ª–æ–≥</a>
            </div>
            <p id="login-error" class="error-message" style="display:none;"></p>
        </div>

        <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–ø–∏—Å–µ–π -->
        <div id="editor-area" style="display:none; margin-top:1.25rem;">
            <div style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
            </div>

            <label for="post-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input id="post-title" type="text" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–ø–∏—Å–∏" />

            <label for="post-excerpt">–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ / –∞–Ω–æ–Ω—Å</label>
            <input id="post-excerpt" type="text" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ" />

            <label for="post-content">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (—Ä–∞–∑—Ä–µ—à–µ–Ω—ã –ø—Ä–æ—Å—Ç—ã–µ —Ç–µ–≥–∏: b, i, strong, em, p, br)</label>
            <textarea id="post-content" rows="8" placeholder="–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Å–∏ (HTML –æ–≥—Ä–∞–Ω–∏—á–µ–Ω)"></textarea>

            <label for="post-photos">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 6)</label>
            <input id="post-photos" type="file" accept="image/*" multiple />
            <small class="muted">–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ 6 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –û–Ω–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–ø–∏—Å–∏.</small>

            <label for="post-locale" style="margin-top:0.75rem;">–ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤</label>
            <select id="post-locale">
                <option value="all">–û–±–µ –≤–µ—Ä—Å–∏–∏ (ET + RU)</option>
                <option value="et">–≠—Å—Ç–æ–Ω—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (ET)</option>
                <option value="ru" selected>–†—É—Å—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (RU)</option>
            </select>

            <div class="admin-actions">
                <button id="save-post" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                <button id="update-post" class="btn" style="display:none;background:#28a745;color:white;">‚úèÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                <button id="cancel-edit" class="btn" style="display:none;background:#6c757d;color:white;">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
                <button id="manage-posts" class="btn" style="background:#17a2b8;color:white;">üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏</button>
                <button id="change-password-btn" class="btn" style="background:#ffc107;color:#212529;font-weight:600;">üîë –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <button id="logout-btn" class="btn" style="background:#fff;color:#dc3545;border:1px solid #eee;">üö™ –í—ã–π—Ç–∏</button>
                <a href="blog.html" class="btn" style="background:#fff;color:var(--primary-color);border:1px solid #eee;">üìñ –ë–ª–æ–≥</a>
            </div>

            <div id="admin-feedback" class="muted" style="margin-top:0.75rem;"></div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏ -->
        <div id="posts-management" style="display:none; margin-top:1.25rem;">
            <div style="background: #e7f3ff; color: #004085; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–º–∏
            </div>

            <div class="admin-actions" style="margin-bottom: 1rem;">
                <button id="back-to-editor" class="btn">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É</button>
                <button id="refresh-posts" class="btn" style="background:#28a745;color:white;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>

            <div id="posts-list">
                <div id="posts-loading" style="text-align:center;padding:2rem;color:#666;">
                    ‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã...
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è -->
        <div id="change-password-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:2rem;border-radius:8px;max-width:400px;width:90%;">
                <h3 style="margin:0 0 1rem 0;">üîë –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
                
                <label for="current-password">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                <input id="current-password" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" style="width:100%;padding:0.75rem;border:1px solid #ddd;border-radius:6px;margin-bottom:1rem;" />
                
                <label for="new-password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                <input id="new-password" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" style="width:100%;padding:0.75rem;border:1px solid #ddd;border-radius:6px;margin-bottom:1rem;" />
                
                <label for="confirm-password">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                <input id="confirm-password" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" style="width:100%;padding:0.75rem;border:1px solid #ddd;border-radius:6px;margin-bottom:1rem;" />
                
                <div id="password-error" class="error-message" style="display:none;margin-bottom:1rem;"></div>
                
                <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
                    <button id="cancel-password-change" class="btn" style="background:#6c757d;color:white;">–û—Ç–º–µ–Ω–∞</button>
                    <button id="confirm-password-change" class="btn" style="background:#28a745;color:white;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </main>

    <script type="module" src="script.js"></script>
    <script type="module">
        // Admin password - will be loaded from config
        let ADMIN_PASSWORD = 'flamingo2024'; // fallback
        
        // GitHub token will be loaded from Netlify function
        let GITHUB_TOKEN = null;


        // Load config from Netlify function
        async function loadConfig() {
            try {
                const response = await fetch('/.netlify/functions/get-config');
                if (response.ok) {
                    const config = await response.json();
                    GITHUB_TOKEN = config.GITHUB_TOKEN;
                    // –ü–∞—Ä–æ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                    console.log('‚úÖ Config loaded from Netlify');
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è Netlify config not available, using fallback');
                    return false;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Config load error:', error);
                return false;
            }
        }

        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', async function() {
            // Load config first
            await loadConfig();
            
            // DOM elements
            const loginArea = document.getElementById('login-area');
            const editorArea = document.getElementById('editor-area');
            const loginBtn = document.getElementById('login-btn');
            const loginInput = document.getElementById('admin-password');
            const loginError = document.getElementById('login-error');
            const saveBtn = document.getElementById('save-post');
            const updateBtn = document.getElementById('update-post');
            const cancelEditBtn = document.getElementById('cancel-edit');
            const managePostsBtn = document.getElementById('manage-posts');
            const backToEditorBtn = document.getElementById('back-to-editor');
            const refreshPostsBtn = document.getElementById('refresh-posts');
            const logoutBtn = document.getElementById('logout-btn');
            const feedback = document.getElementById('admin-feedback');
            const photosInput = document.getElementById('post-photos');
            const postsManagement = document.getElementById('posts-management');
            const postsList = document.getElementById('posts-list');
            
            // Password change elements
            const changePasswordBtn = document.getElementById('change-password-btn');
            const changePasswordModal = document.getElementById('change-password-modal');
            const cancelPasswordChange = document.getElementById('cancel-password-change');
            const confirmPasswordChange = document.getElementById('confirm-password-change');
            const currentPasswordInput = document.getElementById('current-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const passwordError = document.getElementById('password-error');
            
            // Current editing state
            let currentEditingPost = null;

        // Check if already logged in
        if (sessionStorage.getItem('flamingo_admin_authed') === '1') {
            showEditor();
        }

        function showEditor() {
            loginArea.style.display = 'none';
            editorArea.style.display = 'block';
            feedback.textContent = '';
        }

        function showLogin() {
            loginArea.style.display = 'block';
            editorArea.style.display = 'none';
            loginInput.value = '';
            feedback.textContent = '';
        }

        // Login button handler
        loginBtn.addEventListener('click', () => {
            loginError.style.display = 'none';
            
            if (loginInput.value === ADMIN_PASSWORD) {
                sessionStorage.setItem('flamingo_admin_authed', '1');
                showEditor();
            } else {
                // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–∞—Ä–æ–ª–µ - –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ
                loginInput.value = '';
                loginInput.focus();
                // –ù–∏–∫–∞–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            }
        });

        // Allow Enter key to submit login
        loginInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        });

        // Logout button handler
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('flamingo_admin_authed');
            showLogin();
        });

        // Show posts management
        managePostsBtn.addEventListener('click', () => {
            editorArea.style.display = 'none';
            postsManagement.style.display = 'block';
            loadPosts();
        });

        // Back to editor
        backToEditorBtn.addEventListener('click', () => {
            postsManagement.style.display = 'none';
            editorArea.style.display = 'block';
            cancelEdit();
        });

        // Refresh posts
        refreshPostsBtn.addEventListener('click', () => {
            loadPosts();
        });

        // Cancel edit
        cancelEditBtn.addEventListener('click', () => {
            cancelEdit();
        });

        // Update post handler
        updateBtn.addEventListener('click', async () => {
            if (!currentEditingPost) return;

            const title = document.getElementById('post-title').value.trim();
            const excerpt = document.getElementById('post-excerpt').value.trim();
            const content = document.getElementById('post-content').value.trim();
            const locale = document.getElementById('post-locale').value;

            if (!title || !excerpt) {
                feedback.textContent = '–£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.';
                return;
            }

            feedback.textContent = '‚è≥ –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å...';
            updateBtn.disabled = true;

            try {
                // Process photos
                const files = photosInput ? Array.from(photosInput.files).slice(0, 6) : [];
                const photosData = [];
                for (const file of files) {
                    try {
                        photosData.push(await readFileAsDataURL(file));
                    } catch (e) {
                        console.warn('Failed to read photo', e);
                    }
                }

                // Update post object
                const updatedPost = {
                    ...currentEditingPost,
                    title,
                    excerpt,
                    content,
                    locale,
                    photos: files.length > 0 ? photosData : currentEditingPost.photos
                };

                // Update via Netlify function
                await updatePost(updatedPost, currentEditingPost.filename, currentEditingPost.sha);

                feedback.textContent = '‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!';
                cancelEdit();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                feedback.textContent = `‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}`;
            } finally {
                updateBtn.disabled = false;
            }
        });

        // Save post handler
        saveBtn.addEventListener('click', async () => {
            const title = document.getElementById('post-title').value.trim();
            const excerpt = document.getElementById('post-excerpt').value.trim();
            const content = document.getElementById('post-content').value.trim();
            const locale = document.getElementById('post-locale').value;

            if (!title || !excerpt) {
                feedback.textContent = '–£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.';
                return;
            }



            feedback.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø–∏—Å—å –≤ GitHub...';
            saveBtn.disabled = true;

            try {
                // Process photos
                const files = photosInput ? Array.from(photosInput.files).slice(0, 6) : [];
                const photosData = [];
                for (const file of files) {
                    try {
                        photosData.push(await readFileAsDataURL(file));
                    } catch (e) {
                        console.warn('Failed to read photo', e);
                    }
                }

                // Create post object
                const post = {
                    id: Date.now(),
                    title,
                    excerpt,
                    content,
                    created: new Date().toISOString(),
                    locale,
                    photos: photosData,
                    author: 'Flamingo Auto'
                };

                // Save to GitHub
                await savePostToGitHub(post);

                feedback.textContent = '‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ GitHub! –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–ª–æ–≥–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ—ë.';
                
                // Reset form
                document.getElementById('post-title').value = '';
                document.getElementById('post-excerpt').value = '';
                document.getElementById('post-content').value = '';
                document.getElementById('post-locale').value = 'ru';
                if (photosInput) photosInput.value = '';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                feedback.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`;
            } finally {
                saveBtn.disabled = false;
            }
        });

        // Save post to GitHub via Netlify function
        async function savePostToGitHub(post) {
            const response = await fetch('/.netlify/functions/create-blog-post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(post)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }

            return response.json();
        }

        // Load posts from GitHub
        async function loadPosts() {
            const loadingDiv = document.getElementById('posts-loading');
            loadingDiv.style.display = 'block';
            loadingDiv.textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã...';

            try {
                const response = await fetch('/.netlify/functions/get-blog-posts');
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤');
                }

                const posts = await response.json();
                displayPosts(posts);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:', error);
                loadingDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`;
            }
        }

        // Display posts list
        function displayPosts(posts) {
            const loadingDiv = document.getElementById('posts-loading');
            loadingDiv.style.display = 'none';

            if (posts.length === 0) {
                postsList.innerHTML = '<div style="text-align:center;padding:2rem;color:#666;">üìù –ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                return;
            }

            const postsHtml = posts.map((post, index) => `
                <div class="post-item">
                    <h3>${post.title}</h3>
                    <div class="post-meta">
                        üìÖ ${new Date(post.created).toLocaleDateString('ru-RU')}
                        ${post.updated ? `‚Ä¢ ‚úèÔ∏è ${new Date(post.updated).toLocaleDateString('ru-RU')}` : ''}
                        ‚Ä¢ üåê ${post.locale === 'all' ? 'ET + RU' : post.locale.toUpperCase()}
                        ${post.photos && post.photos.length > 0 ? `‚Ä¢ üì∑ ${post.photos.length} —Ñ–æ—Ç–æ` : ''}
                    </div>
                    <p style="margin:0.5rem 0;color:#6c757d;">${post.excerpt}</p>
                    <div class="post-actions">
                        <button class="btn edit-post-btn" data-filename="${post.filename}" style="background:#ffc107;color:#212529;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn delete-post-btn" data-filename="${post.filename}" data-sha="${post.sha}" data-title="${post.title}" style="background:#dc3545;color:white;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');

            postsList.innerHTML = postsHtml;

            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-post-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const filename = btn.dataset.filename;
                    editPost(filename);
                });
            });

            document.querySelectorAll('.delete-post-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const filename = btn.dataset.filename;
                    const sha = btn.dataset.sha;
                    const title = btn.dataset.title;
                    deletePost(filename, sha, title);
                });
            });
        }

        // Edit post
        async function editPost(filename) {
            try {
                const response = await fetch('/.netlify/functions/get-blog-posts');
                const posts = await response.json();
                const post = posts.find(p => p.filename === filename);
                
                if (!post) {
                    alert('–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                // Fill form with post data
                document.getElementById('post-title').value = post.title;
                document.getElementById('post-excerpt').value = post.excerpt;
                document.getElementById('post-content').value = post.content;
                document.getElementById('post-locale').value = post.locale;

                // Set editing state
                currentEditingPost = post;
                
                // Switch UI to edit mode
                saveBtn.style.display = 'none';
                updateBtn.style.display = 'inline-block';
                cancelEditBtn.style.display = 'inline-block';
                
                // Go back to editor
                postsManagement.style.display = 'none';
                editorArea.style.display = 'block';
                
                feedback.textContent = `‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${post.title}`;
                
            } catch (error) {
                alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–∞: ${error.message}`);
            }
        }

        // Update post
        async function updatePost(post, filename, sha) {
            const response = await fetch('/.netlify/functions/update-blog-post', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ post, filename, sha })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            }

            return response.json();
        }

        // Delete post
        async function deletePost(filename, sha, title) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç "${title}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/delete-blog-post', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename, sha, title })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }

                alert('‚úÖ –ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                loadPosts(); // Refresh list
                
            } catch (error) {
                alert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`);
            }
        }

        // Cancel edit mode
        function cancelEdit() {
            currentEditingPost = null;
            
            // Reset form
            document.getElementById('post-title').value = '';
            document.getElementById('post-excerpt').value = '';
            document.getElementById('post-content').value = '';
            document.getElementById('post-locale').value = 'ru';
            if (photosInput) photosInput.value = '';
            
            // Reset UI
            saveBtn.style.display = 'inline-block';
            updateBtn.style.display = 'none';
            cancelEditBtn.style.display = 'none';
            
            feedback.textContent = '';
        }

        // Helper: read file as data URL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Password change handlers
        changePasswordBtn.addEventListener('click', () => {
            changePasswordModal.style.display = 'block';
            currentPasswordInput.value = '';
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
            passwordError.style.display = 'none';
        });

        cancelPasswordChange.addEventListener('click', () => {
            changePasswordModal.style.display = 'none';
        });

        confirmPasswordChange.addEventListener('click', async () => {
            const currentPassword = currentPasswordInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();

            passwordError.style.display = 'none';

            // Validate inputs
            if (!currentPassword || !newPassword || !confirmPassword) {
                passwordError.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                passwordError.style.display = 'block';
                return;
            }

            if (currentPassword !== ADMIN_PASSWORD) {
                passwordError.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å';
                passwordError.style.display = 'block';
                currentPasswordInput.value = '';
                currentPasswordInput.focus();
                return;
            }

            if (newPassword.length < 6) {
                passwordError.textContent = '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                passwordError.style.display = 'block';
                newPasswordInput.focus();
                return;
            }

            if (newPassword !== confirmPassword) {
                passwordError.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                passwordError.style.display = 'block';
                confirmPasswordInput.value = '';
                confirmPasswordInput.focus();
                return;
            }

            try {
                confirmPasswordChange.disabled = true;
                confirmPasswordChange.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–º–µ–Ω—É –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ Netlify —Ñ—É–Ω–∫—Ü–∏—é
                const response = await fetch('/.netlify/functions/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è');
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                alert(`‚úÖ ${result.message}\n\n${result.note || ''}`);
                
                changePasswordModal.style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
                ADMIN_PASSWORD = newPassword;
                
            } catch (error) {
                passwordError.textContent = error.message;
                passwordError.style.display = 'block';
            } finally {
                confirmPasswordChange.disabled = false;
                confirmPasswordChange.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            }
        });

        // Close modal on outside click
        changePasswordModal.addEventListener('click', (e) => {
            if (e.target === changePasswordModal) {
                changePasswordModal.style.display = 'none';
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && changePasswordModal.style.display === 'block') {
                changePasswordModal.style.display = 'none';
            }
        });

        }); // End DOMContentLoaded
    </script>
</body>
</html>