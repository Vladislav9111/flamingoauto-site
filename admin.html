<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin ‚Äî Flamingo Auto</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <style>
        /* Admin panel styling based on archive version */
        .admin-panel { 
            max-width: 900px; 
            margin: 2rem auto; 
            padding: 1.25rem; 
            background: #fff; 
            border-radius: 8px; 
        }
        .admin-panel h1 { margin-bottom: 0.5rem; }
        .admin-panel label { display: block; margin-top: 0.75rem; font-weight: 600; }
        .admin-panel input[type="text"], .admin-panel textarea, .admin-panel select { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
        }
        .admin-actions { 
            margin-top: 1rem; 
            display: flex; 
            gap: 0.75rem; 
            flex-wrap: wrap; 
        }
        .muted { color: #666; font-size: 0.95rem; }
        .error-message { color: #dc3545; margin-top: 0.5rem; }
        .success-message { color: #28a745; margin-top: 0.5rem; }
        
        /* Login section */
        .login-section {
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .login-btn {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .login-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <main class="container admin-panel">
        <div class="hero-header">
            <a class="logo" href="index.html">FLAMINGO AUTO</a>
            <div class="lang-switch" role="tablist" aria-label="Language switch">
                <a class="lang-btn" href="index.html" aria-pressed="true" role="tab">ET</a>
                <a class="lang-btn" href="ru.html" aria-pressed="false" role="tab">RU</a>
            </div>
        </div>
        
        <h1>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
        <p class="muted">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –±–ª–æ–≥.</p>

        <!-- –°–µ–∫—Ü–∏—è –≤—Ö–æ–¥–∞ -->
        <div id="login-area" class="login-section">
            <h3>üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
            <p class="muted">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Netlify Identity</p>
            <button id="login-btn" class="login-btn">üîë –í–æ–π—Ç–∏</button>
            <div class="admin-actions" style="margin-top: 1rem; justify-content: center;">
                <a href="blog.html" class="btn" style="background:#fff;color:var(--primary-color);border:1px solid #eee;">üìñ –ë–ª–æ–≥</a>
            </div>
            <p id="login-error" class="error-message" style="display:none;"></p>
        </div>

        <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–ø–∏—Å–µ–π -->
        <div id="editor-area" style="display:none; margin-top:1.25rem;">
            <div style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: <span id="user-email"></span>
            </div>

            <label for="post-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input id="post-title" type="text" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–ø–∏—Å–∏" />

            <label for="post-excerpt">–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ / –∞–Ω–æ–Ω—Å</label>
            <input id="post-excerpt" type="text" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ" />

            <label for="post-content">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (—Ä–∞–∑—Ä–µ—à–µ–Ω—ã –ø—Ä–æ—Å—Ç—ã–µ —Ç–µ–≥–∏: b, i, strong, em, p, br)</label>
            <textarea id="post-content" rows="8" placeholder="–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Å–∏ (HTML –æ–≥—Ä–∞–Ω–∏—á–µ–Ω)"></textarea>

            <label for="post-photos">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 6)</label>
            <input id="post-photos" type="file" accept="image/*" multiple />
            <small class="muted">–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ 6 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –û–Ω–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–ø–∏—Å–∏.</small>

            <label for="post-locale" style="margin-top:0.75rem;">–ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤</label>
            <select id="post-locale">
                <option value="all">–û–±–µ –≤–µ—Ä—Å–∏–∏ (ET + RU)</option>
                <option value="et">–≠—Å—Ç–æ–Ω—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (ET)</option>
                <option value="ru" selected>–†—É—Å—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (RU)</option>
            </select>

            <div class="admin-actions">
                <button id="save-post" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                <button id="logout-btn" class="btn" style="background:#fff;color:#dc3545;border:1px solid #eee;">üö™ –í—ã–π—Ç–∏</button>
                <a href="blog.html" class="btn" style="background:#fff;color:var(--primary-color);border:1px solid #eee;">üìñ –ë–ª–æ–≥</a>
            </div>

            <div id="admin-feedback" class="muted" style="margin-top:0.75rem;"></div>
        </div>
    </main>

    <script type="module" src="script.js"></script>
    <script type="module">
        import { GITHUB_TOKEN } from './config.js';
        
        // GitHub API configuration
        const GITHUB_CONFIG = {
            owner: 'flamingoauto',
            repo: 'flamingoauto.github.io',
            token: GITHUB_TOKEN
        };

        // DOM elements
        const loginArea = document.getElementById('login-area');
        const editorArea = document.getElementById('editor-area');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        const userEmail = document.getElementById('user-email');
        const saveBtn = document.getElementById('save-post');
        const logoutBtn = document.getElementById('logout-btn');
        const feedback = document.getElementById('admin-feedback');
        const photosInput = document.getElementById('post-photos');

        let currentUser = null;

        // Initialize Netlify Identity
        console.log('üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º Netlify Identity...');
        
        if (typeof window.netlifyIdentity === 'undefined') {
            console.error('‚ùå Netlify Identity –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
            loginError.textContent = '–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
            loginError.style.display = 'block';
        } else {
            console.log('‚úÖ Netlify Identity –Ω–∞–π–¥–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º...');
            
            window.netlifyIdentity.on("init", user => {
                console.log('‚úÖ Netlify Identity –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                if (user) {
                    console.log('üë§ –ù–∞–π–¥–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user.email);
                    showEditor(user);
                } else {
                    console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    showLogin();
                }
            });

            window.netlifyIdentity.on("login", user => {
                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª:', user.email);
                showEditor(user);
            });

            window.netlifyIdentity.on("logout", () => {
                console.log('üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª');
                showLogin();
            });

            window.netlifyIdentity.on("error", err => {
                console.error('‚ùå –û—à–∏–±–∫–∞ Netlify Identity:', err);
                loginError.textContent = `–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${err.message}`;
                loginError.style.display = 'block';
            });

            try {
                window.netlifyIdentity.init();
                console.log('üîÑ Netlify Identity.init() –≤—ã–∑–≤–∞–Ω');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                loginError.textContent = `–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`;
                loginError.style.display = 'block';
            }
        }

        function showEditor(user) {
            currentUser = user;
            loginArea.style.display = 'none';
            editorArea.style.display = 'block';
            userEmail.textContent = user.email;
            feedback.textContent = '';
        }

        function showLogin() {
            currentUser = null;
            loginArea.style.display = 'block';
            editorArea.style.display = 'none';
            feedback.textContent = '';
        }

        // Login button handler
        loginBtn.addEventListener('click', () => {
            console.log('üîÑ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞');
            loginError.style.display = 'none';
            
            if (typeof window.netlifyIdentity === 'undefined') {
                console.error('‚ùå Netlify Identity –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                loginError.textContent = '–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                loginError.style.display = 'block';
                return;
            }
            
            try {
                console.log('üîÑ –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
                window.netlifyIdentity.open();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                loginError.textContent = `–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`;
                loginError.style.display = 'block';
            }
        });

        // Logout button handler
        logoutBtn.addEventListener('click', () => {
            if (window.netlifyIdentity) {
                window.netlifyIdentity.logout();
            }
        });

        // Save post handler
        saveBtn.addEventListener('click', async () => {
            if (!currentUser) {
                feedback.textContent = '–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.';
                return;
            }

            const title = document.getElementById('post-title').value.trim();
            const excerpt = document.getElementById('post-excerpt').value.trim();
            const content = document.getElementById('post-content').value.trim();
            const locale = document.getElementById('post-locale').value;

            if (!title || !excerpt) {
                feedback.textContent = '–£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.';
                return;
            }

            feedback.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø–∏—Å—å –≤ GitHub...';
            saveBtn.disabled = true;

            try {
                // Process photos
                const files = photosInput ? Array.from(photosInput.files).slice(0, 6) : [];
                const photosData = [];
                for (const file of files) {
                    try {
                        photosData.push(await readFileAsDataURL(file));
                    } catch (e) {
                        console.warn('Failed to read photo', e);
                    }
                }

                // Create post object
                const post = {
                    id: Date.now(),
                    title,
                    excerpt,
                    content,
                    created: new Date().toISOString(),
                    locale,
                    photos: photosData,
                    author: currentUser.email
                };

                // Save to GitHub
                await savePostToGitHub(post);

                feedback.textContent = '‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ GitHub! –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–ª–æ–≥–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ—ë.';
                
                // Reset form
                document.getElementById('post-title').value = '';
                document.getElementById('post-excerpt').value = '';
                document.getElementById('post-content').value = '';
                document.getElementById('post-locale').value = 'ru';
                if (photosInput) photosInput.value = '';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                feedback.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`;
            } finally {
                saveBtn.disabled = false;
            }
        });

        // Save post to GitHub
        async function savePostToGitHub(post) {
            const fileName = `content/posts/${post.id}.json`;
            const content = JSON.stringify(post, null, 2);
            const encodedContent = btoa(unescape(encodeURIComponent(content)));

            const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${fileName}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `Add blog post: ${post.title}`,
                    content: encodedContent,
                    committer: {
                        name: 'Flamingo Auto Admin',
                        email: currentUser.email
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || '–û—à–∏–±–∫–∞ GitHub API');
            }

            return response.json();
        }

        // Helper: read file as data URL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>