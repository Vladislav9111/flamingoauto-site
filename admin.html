<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin ‚Äî Flamingo Auto</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <style>
        /* small admin specific tweaks */
        .admin-panel { max-width:900px; margin:2rem auto; padding:1.25rem; background:#fff; border-radius:8px; }
        .admin-panel h1 { margin-bottom:0.5rem; }
        .admin-panel label { display:block; margin-top:0.75rem; font-weight:600; }
        .admin-panel input[type="text"], .admin-panel textarea { width:100%; padding:0.75rem; border:1px solid #ddd; border-radius:6px; }
        .admin-actions { margin-top:1rem; display:flex; gap:0.75rem; flex-wrap:wrap; }
        .muted { color:#666; font-size:0.95rem; }
    </style>
</head>
<body>
    <main class="container admin-panel">
        <div class="hero-header">
            <a class="logo" href="index.html">FLAMINGO AUTO</a>
            <div class="lang-switch" role="tablist" aria-label="Language switch">
                <a class="lang-btn" href="index.html" aria-pressed="true" role="tab">ET</a>
                <a class="lang-btn" href="ru.html" aria-pressed="false" role="tab">RU</a>
            </div>
        </div>
        <h1>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
        <p class="muted">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Netlify Identity –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–≥–æ–º.</p>

        <div id="login-area">
            <div id="netlify-login" style="text-align: center; margin: 2rem 0;">
                <!-- Netlify Identity widget will be inserted here automatically -->
            </div>
            <div class="admin-actions">
                <a href="blog.html" class="btn" style="background:#fff;color:var(--primary-color);border:1px solid #eee;">–ë–ª–æ–≥</a>
                <a href="admin-simple.html" class="btn" style="background:#28a745;color:white;">üìù –ü—Ä–æ—Å—Ç–∞—è –∞–¥–º–∏–Ω–∫–∞</a>
            </div>
        </div>

        <div id="editor-area" style="display:none; margin-top:1.25rem;">
            <label for="post-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input id="post-title" type="text" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–ø–∏—Å–∏" />

            <label for="post-excerpt">–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ / –∞–Ω–æ–Ω—Å</label>
            <input id="post-excerpt" type="text" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ" />

            <label for="post-content">–¢–µ–ª–æ (—Ä–∞–∑—Ä–µ—à–µ–Ω—ã –ø—Ä–æ—Å—Ç—ã–µ —Ç–µ–≥–∏: b, i, strong, em, p, br)</label>
            <textarea id="post-content" rows="6" placeholder="–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Å–∏ (HTML –æ–≥—Ä–∞–Ω–∏—á–µ–Ω)"></textarea>

            <label for="post-photos">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 6)</label>
            <input id="post-photos" type="file" accept="image/*" multiple />
            <small class="muted">–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ 6 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –û–Ω–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–ø–∏—Å–∏.(—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–µ –±–æ–ª–µ–µ 1 —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –±–æ–ª—å—à–µ 1 —Ñ–æ—Ç–æ —è —ç—Ç–æ —Ç–æ–∂–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª) </small>

            <!-- Locale selector: choose target blog language -->
            <label for="post-locale" style="margin-top:0.75rem;">–ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤</label>
            <select id="post-locale" style="padding:0.6rem;border:1px solid #ddd;border-radius:6px;">
                <option value="all">–û–±–µ (ET + RU)</option>
                <option value="et">–≠—Å—Ç–æ–Ω—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (ET)</option>
                <option value="ru" selected>–†—É—Å—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (RU)</option>
            </select>

            <div class="admin-actions">
                <button id="save-post" class="btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                <button id="clear-posts" class="btn" style="background:#fff;color:var(--primary-color);border:1px solid #eee;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                <button id="logout-btn" class="btn" style="background:#fff;color:#dc3545;border:1px solid #eee;">–í—ã–π—Ç–∏</button>
            </div>

            <div id="admin-feedback" class="muted" style="margin-top:0.75rem;"></div>
        </div>

    </main>

    <script type="module" src="script.js"></script>
    <script>
        // Netlify Identity authentication logic
        (function() {
            const loginArea = document.getElementById('login-area');
            const editorArea = document.getElementById('editor-area');
            const saveBtn = document.getElementById('save-post');
            const clearBtn = document.getElementById('clear-posts');
            const logoutBtn = document.getElementById('logout-btn');
            const feedback = document.getElementById('admin-feedback');
            const photosInput = document.getElementById('post-photos');

            function showEditor() {
                loginArea.style.display = 'none';
                editorArea.style.display = '';
                if (feedback) feedback.textContent = '';
            }

            function showLogin() {
                loginArea.style.display = '';
                editorArea.style.display = 'none';
                if (feedback) feedback.textContent = '';
            }

            // Check if user is logged in
            function checkAuthStatus() {
                if (typeof netlifyIdentity !== 'undefined') {
                    const user = netlifyIdentity.currentUser();
                    if (user) {
                        showEditor();
                    } else {
                        showLogin();
                    }
                }
            }

            // Initialize when Netlify Identity loads
            if (typeof netlifyIdentity !== 'undefined') {
                netlifyIdentity.on('init', checkAuthStatus);
                netlifyIdentity.on('login', showEditor);
                netlifyIdentity.on('logout', showLogin);
                netlifyIdentity.init();
                
                // Create single login widget
                const loginDiv = document.getElementById('netlify-login');
                if (loginDiv && !loginDiv.querySelector('.netlify-identity-button')) {
                    const button = document.createElement('button');
                    button.textContent = '–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
                    button.className = 'btn netlify-identity-button';
                    button.onclick = () => netlifyIdentity.open();
                    loginDiv.appendChild(button);
                }
            } else {
                // Wait for script to load
                setTimeout(() => {
                    if (typeof netlifyIdentity !== 'undefined') {
                        netlifyIdentity.on('init', checkAuthStatus);
                        netlifyIdentity.on('login', showEditor);
                        netlifyIdentity.on('logout', showLogin);
                        netlifyIdentity.init();
                        
                        // Create single login widget
                        const loginDiv = document.getElementById('netlify-login');
                        if (loginDiv && !loginDiv.querySelector('.netlify-identity-button')) {
                            const button = document.createElement('button');
                            button.textContent = '–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
                            button.className = 'btn netlify-identity-button';
                            button.onclick = () => netlifyIdentity.open();
                            loginDiv.appendChild(button);
                        }
                    }
                }, 1000);
            }

            // Logout button handler
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    netlifyIdentity.logout();
                });
            }

            // Blog post management logic
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    const user = netlifyIdentity.currentUser();
                    if (!user) {
                        if (feedback) feedback.textContent = '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.';
                        return;
                    }

                    const title = document.getElementById('post-title').value.trim();
                    const excerpt = document.getElementById('post-excerpt').value.trim();
                    const content = document.getElementById('post-content').value.trim();
                    const localeSelect = document.getElementById('post-locale');
                    const locale = localeSelect ? localeSelect.value : 'all';
                    
                    if (!title || !excerpt) {
                        if (feedback) feedback.textContent = '–£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.';
                        return;
                    }
                    
                    try {
                        if (feedback) feedback.textContent = '–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç—å–∏...';
                        
                        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è Git Gateway
                        const token = user.token?.access_token;
                        if (!token) {
                            throw new Error('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.');
                        }
                        
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                        const files = photosInput ? Array.from(photosInput.files).slice(0,6) : [];
                        const imageUrls = [];
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            const formData = new FormData();
                            formData.append('file', file);
                            
                            try {
                                const uploadResponse = await fetch('/.netlify/functions/upload-image', {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: formData
                                });
                                
                                if (uploadResponse.ok) {
                                    const result = await uploadResponse.json();
                                    imageUrls.push(result.url);
                                } else {
                                    console.warn('Failed to upload image:', file.name);
                                }
                            } catch (uploadError) {
                                console.warn('Error uploading image:', uploadError);
                            }
                        }
                        
                        // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ markdown —Ñ–∞–π–ª–∞
                        const now = new Date();
                        const dateStr = now.toISOString().split('T')[0];
                        const slug = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                        const filename = `${dateStr}-${slug}.md`;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–Ω—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
                        let contentWithImages = content;
                        if (imageUrls.length > 0) {
                            const imagesMarkdown = imageUrls.map((url, index) => 
                                `![–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${index + 1}](${url})`
                            ).join('\n\n');
                            contentWithImages = content + '\n\n' + imagesMarkdown;
                        }
                        
                        const frontmatter = `---
title: "${title}"
date: ${now.toISOString()}
excerpt: "${excerpt}"
author: "${user.email || user.user_metadata?.full_name || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}"
locale: "${locale}"
published: true
${imageUrls.length > 0 ? `images:\n${imageUrls.map(url => `  - "${url}"`).join('\n')}` : ''}
---

${contentWithImages}`;
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Netlify Git Gateway
                        const apiUrl = `/.netlify/git/github/contents/content/blog/${filename}`;
                        
                        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
                        let existingFile = null;
                        try {
                            const checkResponse = await fetch(apiUrl, {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/vnd.github.v3+json',
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'User-Agent': 'Netlify-CMS/2.0',
                                    'X-Netlify-Site-Id': window.ENV?.NETLIFY_SITE_ID || window.location.hostname,
                                    'Origin': window.location.origin
                                }
                            });
                            
                            if (checkResponse.ok) {
                                existingFile = await checkResponse.json();
                            }
                        } catch (error) {
                            // –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
                            console.log('File does not exist, creating new file');
                        }
                        
                        // –ï—Å–ª–∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—É—Ñ—Ñ–∏–∫—Å –∫ –∏–º–µ–Ω–∏
                        let finalFilename = filename;
                        if (existingFile) {
                            const timestamp = Date.now();
                            const baseName = filename.replace('.md', '');
                            finalFilename = `${baseName}-${timestamp}.md`;
                            console.log(`File exists, using new name: ${finalFilename}`);
                        }
                        
                        const finalApiUrl = `/.netlify/git/github/contents/content/blog/${finalFilename}`;
                        
                        const requestBody = {
                            message: `–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è: ${title}`,
                            content: btoa(unescape(encodeURIComponent(frontmatter))),
                            author: {
                                name: user.user_metadata?.full_name || user.email,
                                email: user.email
                            }
                        };
                        
                        // –ï—Å–ª–∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ, –¥–æ–±–∞–≤–ª—è–µ–º SHA
                        if (existingFile && finalFilename === filename) {
                            requestBody.sha = existingFile.sha;
                        }
                        
                        const response = await fetch(finalApiUrl, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/vnd.github.v3+json',
                                'X-Requested-With': 'XMLHttpRequest',
                                'User-Agent': 'Netlify-CMS/2.0',
                                'X-Netlify-Site-Id': window.ENV?.NETLIFY_SITE_ID || window.location.hostname,
                                'Origin': window.location.origin
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            let errorMessage;
                            try {
                                const errorData = JSON.parse(errorText);
                                errorMessage = errorData.message || errorData.msg || errorText;
                            } catch {
                                errorMessage = errorText;
                            }
                            
                            console.error('API Error:', {
                                status: response.status,
                                statusText: response.statusText,
                                headers: Object.fromEntries(response.headers.entries()),
                                body: errorText
                            });
                            
                            throw new Error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${response.status} - ${errorMessage}`);
                        }
                        
                        if (feedback) feedback.textContent = '–°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞! –û–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.';
                        
                        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                        document.getElementById('post-title').value = '';
                        document.getElementById('post-excerpt').value = '';
                        document.getElementById('post-content').value = '';
                        if (localeSelect) localeSelect.value = 'ru';
                        if (photosInput) photosInput.value = '';
                        
                    } catch (error) {
                        console.error('Error saving post:', error);
                        if (feedback) feedback.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                    }
                });
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    const user = netlifyIdentity.currentUser();
                    if (!user) {
                        if (feedback) feedback.textContent = '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.';
                        return;
                    }
                    
                    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –±–ª–æ–≥–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
                    localStorage.removeItem(window.FlamingoBlog.POSTS_KEY);
                    if (feedback) feedback.textContent = '–í—Å–µ –∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã.';
                });
            }
        })();
    </script>
</body>
</html>