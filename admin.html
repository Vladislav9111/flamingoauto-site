<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin — Flamingo Auto</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <style>
        /* small admin specific tweaks */
        .admin-panel { max-width:900px; margin:2rem auto; padding:1.25rem; background:#fff; border-radius:8px; }
        .admin-panel h1 { margin-bottom:0.5rem; }
        .admin-panel label { display:block; margin-top:0.75rem; font-weight:600; }
        .admin-panel input[type="text"], .admin-panel textarea { width:100%; padding:0.75rem; border:1px solid #ddd; border-radius:6px; }
        .admin-actions { margin-top:1rem; display:flex; gap:0.75rem; flex-wrap:wrap; }
        .muted { color:#666; font-size:0.95rem; }
    </style>
</head>
<body>
    <main class="container admin-panel">
        <div class="hero-header">
            <a class="logo" href="index.html">FLAMINGO AUTO</a>
            <div class="lang-switch" role="tablist" aria-label="Language switch">
                <a class="lang-btn" href="index.html" aria-pressed="true" role="tab">ET</a>
                <a class="lang-btn" href="ru.html" aria-pressed="false" role="tab">RU</a>
            </div>
        </div>
        <h1>Административная панель</h1>
        <p class="muted">Войдите через Netlify Identity для управления блогом.</p>

        <div id="login-area">
            <div id="netlify-login" style="text-align: center; margin: 2rem 0;">
                <!-- Netlify Identity widget will be inserted here automatically -->
            </div>
            <div class="admin-actions">
                <a href="blog.html" class="btn" style="background:#fff;color:var(--primary-color);border:1px solid #eee;">Блог</a>
            </div>
        </div>

        <div id="editor-area" style="display:none; margin-top:1.25rem;">
            <label for="post-title">Заголовок</label>
            <input id="post-title" type="text" placeholder="Заголовок записи" />

            <label for="post-excerpt">Короткое описание / анонс</label>
            <input id="post-excerpt" type="text" placeholder="Короткий текст, который будет виден в списке" />

            <label for="post-content">Тело (разрешены простые теги: b, i, strong, em, p, br)</label>
            <textarea id="post-content" rows="6" placeholder="Полный текст записи (HTML ограничен)"></textarea>

            <label for="post-photos">Фотографии (до 6)</label>
            <input id="post-photos" type="file" accept="image/*" multiple />
            <small class="muted">Вы можете добавить до 6 изображений. Они будут отображаться в карточке записи.(рекомендуется не более 1 фото, если больше 1 фото я это тоже адаптировал) </small>

            <!-- Locale selector: choose target blog language -->
            <label for="post-locale" style="margin-top:0.75rem;">Публиковать в</label>
            <select id="post-locale" style="padding:0.6rem;border:1px solid #ddd;border-radius:6px;">
                <option value="all">Обе (ET + RU)</option>
                <option value="et">Эстонская страница (ET)</option>
                <option value="ru" selected>Русская страница (RU)</option>
            </select>

            <div class="admin-actions">
                <button id="save-post" class="btn">Опубликовать</button>
                <button id="clear-posts" class="btn" style="background:#fff;color:var(--primary-color);border:1px solid #eee;">Очистить все</button>
                <button id="logout-btn" class="btn" style="background:#fff;color:#dc3545;border:1px solid #eee;">Выйти</button>
            </div>

            <div id="admin-feedback" class="muted" style="margin-top:0.75rem;"></div>
        </div>

    </main>

    <script type="module" src="script.js"></script>
    <script>
        // Netlify Identity authentication logic
        (function() {
            const loginArea = document.getElementById('login-area');
            const editorArea = document.getElementById('editor-area');
            const saveBtn = document.getElementById('save-post');
            const clearBtn = document.getElementById('clear-posts');
            const logoutBtn = document.getElementById('logout-btn');
            const feedback = document.getElementById('admin-feedback');
            const photosInput = document.getElementById('post-photos');

            function showEditor() {
                loginArea.style.display = 'none';
                editorArea.style.display = '';
                if (feedback) feedback.textContent = '';
            }

            function showLogin() {
                loginArea.style.display = '';
                editorArea.style.display = 'none';
                if (feedback) feedback.textContent = '';
            }

            // Check if user is logged in
            function checkAuthStatus() {
                if (typeof netlifyIdentity !== 'undefined') {
                    const user = netlifyIdentity.currentUser();
                    if (user) {
                        showEditor();
                    } else {
                        showLogin();
                    }
                }
            }

            // Initialize when Netlify Identity loads
            if (typeof netlifyIdentity !== 'undefined') {
                netlifyIdentity.on('init', checkAuthStatus);
                netlifyIdentity.on('login', showEditor);
                netlifyIdentity.on('logout', showLogin);
                netlifyIdentity.init();
                
                // Create single login widget
                const loginDiv = document.getElementById('netlify-login');
                if (loginDiv && !loginDiv.querySelector('.netlify-identity-button')) {
                    const button = document.createElement('button');
                    button.textContent = 'Вход / Регистрация';
                    button.className = 'btn netlify-identity-button';
                    button.onclick = () => netlifyIdentity.open();
                    loginDiv.appendChild(button);
                }
            } else {
                // Wait for script to load
                setTimeout(() => {
                    if (typeof netlifyIdentity !== 'undefined') {
                        netlifyIdentity.on('init', checkAuthStatus);
                        netlifyIdentity.on('login', showEditor);
                        netlifyIdentity.on('logout', showLogin);
                        netlifyIdentity.init();
                        
                        // Create single login widget
                        const loginDiv = document.getElementById('netlify-login');
                        if (loginDiv && !loginDiv.querySelector('.netlify-identity-button')) {
                            const button = document.createElement('button');
                            button.textContent = 'Вход / Регистрация';
                            button.className = 'btn netlify-identity-button';
                            button.onclick = () => netlifyIdentity.open();
                            loginDiv.appendChild(button);
                        }
                    }
                }, 1000);
            }

            // Logout button handler
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    netlifyIdentity.logout();
                });
            }

            // Blog post management logic
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    const user = netlifyIdentity.currentUser();
                    if (!user) {
                        if (feedback) feedback.textContent = 'Необходимо войти в систему.';
                        return;
                    }

                    const title = document.getElementById('post-title').value.trim();
                    const excerpt = document.getElementById('post-excerpt').value.trim();
                    const content = document.getElementById('post-content').value.trim();
                    const localeSelect = document.getElementById('post-locale');
                    const locale = localeSelect ? localeSelect.value : 'all';
                    
                    if (!title || !excerpt) {
                        if (feedback) feedback.textContent = 'Укажите заголовок и короткое описание.';
                        return;
                    }
                    
                    try {
                        if (feedback) feedback.textContent = 'Публикация статьи...';
                        
                        // Получаем токен для Git Gateway
                        const token = user.token?.access_token;
                        if (!token) {
                            throw new Error('Нет токена доступа. Попробуйте выйти и войти снова.');
                        }
                        
                        // Обработка изображений
                        const files = photosInput ? Array.from(photosInput.files).slice(0,6) : [];
                        const imageUrls = [];
                        
                        // Загружаем изображения если есть
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            const formData = new FormData();
                            formData.append('file', file);
                            
                            try {
                                const uploadResponse = await fetch('/.netlify/functions/upload-image', {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: formData
                                });
                                
                                if (uploadResponse.ok) {
                                    const result = await uploadResponse.json();
                                    imageUrls.push(result.url);
                                } else {
                                    console.warn('Failed to upload image:', file.name);
                                }
                            } catch (uploadError) {
                                console.warn('Error uploading image:', uploadError);
                            }
                        }
                        
                        // Создаем содержимое markdown файла
                        const now = new Date();
                        const dateStr = now.toISOString().split('T')[0];
                        const slug = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                        const filename = `${dateStr}-${slug}.md`;
                        
                        // Добавляем изображения в контент если есть
                        let contentWithImages = content;
                        if (imageUrls.length > 0) {
                            const imagesMarkdown = imageUrls.map((url, index) => 
                                `![Изображение ${index + 1}](${url})`
                            ).join('\n\n');
                            contentWithImages = content + '\n\n' + imagesMarkdown;
                        }
                        
                        const frontmatter = `---
title: "${title}"
date: ${now.toISOString()}
excerpt: "${excerpt}"
author: "${user.email || user.user_metadata?.full_name || 'Администратор'}"
locale: "${locale}"
published: true
${imageUrls.length > 0 ? `images:\n${imageUrls.map(url => `  - "${url}"`).join('\n')}` : ''}
---

${contentWithImages}`;
                        
                        // Отправляем через Netlify Git Gateway
                        const apiUrl = `/.netlify/git/github/contents/content/blog/${filename}`;
                        
                        // Сначала проверяем, существует ли файл
                        let existingFile = null;
                        try {
                            const checkResponse = await fetch(apiUrl, {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });
                            
                            if (checkResponse.ok) {
                                existingFile = await checkResponse.json();
                            }
                        } catch (error) {
                            // Файл не существует, это нормально для нового файла
                            console.log('File does not exist, creating new file');
                        }
                        
                        // Если файл существует, добавляем уникальный суффикс к имени
                        let finalFilename = filename;
                        if (existingFile) {
                            const timestamp = Date.now();
                            const baseName = filename.replace('.md', '');
                            finalFilename = `${baseName}-${timestamp}.md`;
                            console.log(`File exists, using new name: ${finalFilename}`);
                        }
                        
                        const finalApiUrl = `/.netlify/git/github/contents/content/blog/${finalFilename}`;
                        
                        const requestBody = {
                            message: `Новая статья: ${title}`,
                            content: btoa(unescape(encodeURIComponent(frontmatter))),
                            author: {
                                name: user.user_metadata?.full_name || user.email,
                                email: user.email
                            }
                        };
                        
                        // Если файл существует и мы обновляем его, добавляем SHA
                        if (existingFile && finalFilename === filename) {
                            requestBody.sha = existingFile.sha;
                        }
                        
                        const response = await fetch(finalApiUrl, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            let errorMessage;
                            try {
                                const errorData = JSON.parse(errorText);
                                errorMessage = errorData.message || errorData.msg || errorText;
                            } catch {
                                errorMessage = errorText;
                            }
                            
                            console.error('API Error:', {
                                status: response.status,
                                statusText: response.statusText,
                                headers: Object.fromEntries(response.headers.entries()),
                                body: errorText
                            });
                            
                            throw new Error(`Ошибка сохранения: ${response.status} - ${errorMessage}`);
                        }
                        
                        if (feedback) feedback.textContent = 'Статья успешно опубликована! Она появится на сайте через несколько минут.';
                        
                        // Очищаем поля
                        document.getElementById('post-title').value = '';
                        document.getElementById('post-excerpt').value = '';
                        document.getElementById('post-content').value = '';
                        if (localeSelect) localeSelect.value = 'ru';
                        if (photosInput) photosInput.value = '';
                        
                    } catch (error) {
                        console.error('Error saving post:', error);
                        if (feedback) feedback.textContent = `Ошибка: ${error.message}`;
                    }
                });
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    const user = netlifyIdentity.currentUser();
                    if (!user) {
                        if (feedback) feedback.textContent = 'Необходимо войти в систему.';
                        return;
                    }
                    
                    if (!confirm('Удалить все записи блога? Это действие нельзя отменить.')) return;
                    localStorage.removeItem(window.FlamingoBlog.POSTS_KEY);
                    if (feedback) feedback.textContent = 'Все записи удалены.';
                });
            }
        })();
    </script>
</body>
</html>